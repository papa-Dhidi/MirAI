{% extends "layout/app_layout.html" %}
{% block title %}{{ movie.title }}{% endblock %}

{% block content %}
{% if movie %}
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8 md:gap-12">
        
        <!-- Left Column: Poster -->
        <div class="md:col-span-1 lg:col-span-1">
            <img src="https://image.tmdb.org/t/p/w780{{ movie.poster_path }}" 
                 alt="{{ movie.title }} Poster"
                 class="rounded-lg shadow-lg w-full"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/780x1170/1e293b/94a3b8?text=No+Image';">
        </div>

        <!-- Right Column: Details -->
        <div class="md:col-span-2 lg:col-span-3 text-white">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">{{ movie.title }}</h1>
            {% if movie.tagline %}<p class="text-xl text-gray-400 mt-2 italic">"{{ movie.tagline }}"</p>{% endif %}
            
            <!-- Meta Info -->
            <div class="flex items-center space-x-4 mt-4 text-gray-300">
                <span class="font-bold">{{ movie.release_date|date:"Y" }}</span>
                <span>&bull;</span>
                <span>{{ movie.runtime }} min</span>
                <span>&bull;</span>
                <span class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    {{ movie.vote_average|floatformat:1 }}
                </span>
            </div>

            <!-- Genres -->
            <div class="mt-4 flex flex-wrap gap-2">
                {% for genre in movie.genres %}
                    <span class="px-3 py-1 bg-blue-600/50 text-blue-200 text-xs font-semibold rounded-full">{{ genre.name }}</span>
                {% endfor %}
            </div>

            <!-- Watchlist Actions -->
            {% if user.is_authenticated %}
            <div class="mt-6">
                {% if is_in_watchlist %}
                    <!-- Form to Remove from Watchlist -->
                    <form action="{% url 'movies:watchlist_remove' movie_id=movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="w-full md:w-auto flex items-center justify-center px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            Remove from Watchlist
                        </button>
                    </form>
                {% else %}
                    <!-- Form to Add to Watchlist -->
                    <form action="{% url 'movies:watchlist_add' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="movie_id" value="{{ movie.id }}">
                        <input type="hidden" name="title" value="{{ movie.title }}">
                        <input type="hidden" name="poster_path" value="{{ movie.poster_path }}">
                        <input type="hidden" name="release_year" value="{{ movie.release_date|date:'Y' }}">
                        <button type="submit" class="w-full md:w-auto flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                            </svg>
                            Add to Watchlist
                        </button>
                    </form>
                {% endif %}
            </div>
            {% endif %}

            <!-- Overview -->
            <div class="mt-8">
                <h2 class="text-2xl font-bold border-b-2 border-slate-700 pb-2 mb-4">Overview</h2>
                <p class="text-gray-300 leading-relaxed">{{ movie.overview }}</p>
            </div>

            <!-- Main Trailer -->
            {% if trailer %}
            <div class="mt-8">
                <h2 class="text-2xl font-bold border-b-2 border-slate-700 pb-2 mb-4">Trailer</h2>
                <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden">
                    <iframe src="https://www.youtube.com/embed/{{ trailer.key }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
            {% endif %}

            <!-- Cast -->
            <div class="mt-8">
                <h2 class="text-2xl font-bold border-b-2 border-slate-700 pb-2 mb-4">Top Cast</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                    {% for person in movie.credits.cast|slice:":10" %}
                        <div class="text-center">
                            {% if person.profile_path %}
                                <img src="https://image.tmdb.org/t/p/w185{{ person.profile_path }}" alt="{{ person.name }}" class="rounded-full w-24 h-24 mx-auto object-cover mb-2 shadow-md">
                            {% else %}
                                <div class="bg-slate-700 rounded-full w-24 h-24 mx-auto flex items-center justify-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            {% endif %}
                            <p class="font-bold text-sm">{{ person.name }}</p>
                            <p class="text-xs text-gray-400">{{ person.character }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
{% else %}
    <div class="text-center py-16 bg-slate-800 rounded-lg">
        <p class="text-2xl text-white">Movie Not Found</p>
        <p class="text-gray-400 mt-2">The requested movie could not be found. Please try again.</p>
        <a href="{% url 'movies:list' %}" class="mt-6 inline-block bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition-colors">
            Back to Movies
        </a>
    </div>
{% endif %}
{% endblock %}
